name: "Ubuntu 22 CI"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  release:
    types:
      - created

jobs:
  build-debug:
    runs-on: ubuntu-22.04
    name: "Bazel Debug Build"
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{github.event.pull_request.head.ref}}
          repository: ${{github.event.pull_request.head.repo.full_name}}

      - name: Bazel cache
        id: cache-bazel-debug
        uses: actions/cache@v3.0.4
        with:
          path: ~/.cache/bazel/
          key: ${{ runner.os }}-bazel-debug

      - name: "Building debug"
        run: |
          bazelisk build --keep_going --disk_cache=~/.cache/bazel/  //...

      - name: "Running tests"
        run: |
          bazelisk test --test_output=all --keep_going --disk_cache=~/.cache/bazel/ //...

  build-docker:
    runs-on: ubuntu-22.04
    name: "Docker Build"
    env:
      AWS_REGION: us-west-2
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{github.event.pull_request.head.ref}}
          repository: ${{github.event.pull_request.head.repo.full_name}}

      - name: Setting Github hash
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Check outputs
        run: echo ${{ steps.vars.outputs.sha_short }}

      - name: Bazel cache
        id: cache-bazel-debug
        uses: actions/cache@v3.0.4
        with:
          path: ~/.cache/bazel/
          key: ${{ runner.os }}-bazel-debug

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: "Build and push Docker"
        run: |
          bazelisk run --test_output=all --keep_going --disk_cache=~/.cache/bazel/ //products/developer-portal:push_image

      - name: "Creating Devops repo update"
        run: |
          git clone git@github.com:Zilliqa/devops.git .infra
          cd .infra && git checkout -b feature/preview-developer-${{ steps.vars.outputs.sha_short }}
          echo "DO NOT MERGE" >> cd/applications/devportal/overlays/preview/kustomization.yaml
          git add . -A
          git commit -m "Preparing preview for commit: ${{ github.sha }}
          git push
        env:
          GITHUB_TOKEN: ${{ github.token }}
